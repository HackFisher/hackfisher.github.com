
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>代码质量系列之六：重复代码实战案例及其分析总结</title>
    
    <meta name="author" content="HackFisher">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>
    <div class="container">
		<header>
			<h1><a href="/">HackFisher</a>  <small>Stay foolish, Stay hungry</small></h1>
		</header>
		<div class="navbar">
		  <div class="container">
		      <ul class="nav">
		        
		        
		        


  
    
      
      	
      	<li><a href="/about.html">About</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/projects.html">Project</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



		      </ul>
		      <form action="http://google.com/search" method="get" class="nav">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:hackfisher.info">
    <input class="search" type="text" name="q" results="0" placeholder="Search">
  </fieldset>
</form>

<ul class="subscription nav" data-subscription="rss">
  <li><a href="/rss.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li> 
</ul>
		    </div>
		</div>
		  <div class="content">
		    
<div class="page-header">
  <h2>代码质量系列之六：重复代码实战案例及其分析总结 </h2>
</div>

<div class="row">
  <div class="span8">
    <span style="font-size: 14px;"><strong>案例一</strong>：使用递归去除嵌套重复代码，不难看出下面的代码一层套一层，但是代码完全一样，递归是最佳解决方案。</span><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;"><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;">if (tokenizer.hasMoreTokens()) {</span></span></span></span>
<div>
<blockquote>
<div>try {</div>
<div>Integer.parseInt(tokenizer.<wbr>nextToken().trim());</wbr></div>
<div>} catch (NumberFormatException nfe) {</div>
<div>throwFormatException();</div>
<div>}</div>
<div>if (tokenizer.hasMoreTokens()) {</div>
<div>try {</div>
<div>Integer.parseInt(tokenizer.<wbr>nextToken().trim());</wbr></div>
<div>} catch (NumberFormatException nfe) {</div>
<div>throwFormatException();</div>
<div>}</div>
<div>if (tokenizer.hasMoreTokens()) {</div>
<div>try {</div>
<div>Integer.parseInt(tokenizer.<wbr>nextToken().trim());</wbr></div>
<div>} catch (NumberFormatException nfe) {</div>
<div>throwFormatException();</div>
<div>}</div>
<div>if (tokenizer.hasMoreTokens()) {</div>
<div>try {</div>
<div>Integer.parseInt(tokenizer.<wbr>nextToken().trim());</wbr></div>
<div>} catch (NumberFormatException nfe) {</div>
<div>throwFormatException();</div>
<div>}</div>
<div>} else {</div>
<div>throwFormatException();</div>
<div>}</div>
<div>} else {</div>
<div>throwFormatException();</div>
<div>}</div>
<div>} else {</div>
<div>throwFormatException();</div>
<div>}</div>
<div>} else {</div>
<div>throwFormatException();</div>
<div>}</div></blockquote>
</div>
<div><strong>案例二</strong>：这个重复代码，很多刚学编程的新手易犯的毛病，内在的逻辑重复，常量完全可以用变量代替：showGuidLine.setEnabled(isSelected());</div>
<div>
<div>
<blockquote>
<div><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">if(isSelected()) {</span></div>
<div>showGuidLine.setEnabled(true);</div>
<div>} else {</div>
<div>showGuidLine.setEnabled(false)<wbr>;</wbr></div>
<div>}</div></blockquote>
</div>
<div><strong>案例三</strong>：Tree, ATree, BTree, CTree，复杂继承为多个类，仅仅因为ATree, BTree, CTree的节点Node或其加载方式不同。</div>
<div>解决方式：保留一个Tree模板，<span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;">NodesLoader用来处理Node，分为ANodeLoader, BNodesLoader等等。</span></span></div>
<div>
<div><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">复杂继承(不利于重用)--&gt;模板+工厂模式+接口抽象--&gt; 组合方式(复合优于继承)</span></div>
<div>利用工厂模式和接口，化整为零，便于复用</div>
<div>面向对象OO，模型细分</div>
<div><strong>案例四</strong>：<span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;">Swing中有很多类似下面例子的小控件，都可以用类似的模式生产：<wbr>一组独立的控件+一个相关接口，这样最大的好处就是解耦，方便复用。</wbr></span></span>
<div>
<div>
<blockquote>
<div>public class SearchPane extends BasicPane {</div>
<div>/*</div>
<div>* 模糊查询用</div>
<div>*/</div>
<div>public JTextField searchField = new JTextField();</div>
<div>public SearchPane(final Searchable searchable) {</div>
<div>final JButton searchButton = new JButton();</div>
<div>searchButton.setIcon(<wbr>BaseUtils.readIcon("/com/fr/<wbr>design/images/m_file/preview.<wbr>png"));</wbr></wbr></wbr></div>
<div>searchButton.setPreferredSize(<wbr>new Dimension(25, this.getHeight()));</wbr></div>
<div>searchButton.<wbr>addActionListener(new ActionListener() {</wbr></div>
<div>@Override</div>
<div>public void actionPerformed(ActionEvent e) {</div>
<div>searchable.search(searchField.<wbr>getText());</wbr></div>
<div>}</div>
<div>});</div>
<div>searchField.addKeyListener(new KeyAdapter() {</div>
<div>public void keyPressed(KeyEvent e) {</div>
<div>if (e.getKeyCode() == KeyEvent.VK_ENTER) {</div>
<div>searchable.search(searchField.<wbr>getText());</wbr></div>
<div>e.consume();</div>
<div>}</div>
<div>}</div>
<div>});</div>
<div>this.setLayout(new BorderLayout());</div>
<div>this.add(searchField,<wbr>BorderLayout.CENTER);</wbr></div>
<div>this.add(searchButton,<wbr>BorderLayout.EAST);</wbr></div>
<div>}</div>
<div><strong>public static interface Searchable {</strong></div>
<div><strong>public void search(String key);</strong></div>
<div><strong>}</strong></div>
<div>}</div></blockquote>
<strong>案例五</strong>：ORM。使用数据结构进行抽象。服务器端JDBC的增删改查CRUD操作相信很多人都不陌生，可是如果有大量的Plain Object的话，一个类写一个会累死你，其实只要思考其本质，抽象一下，就可以概括为一个Map。这是数据库到服务器端内存的映射，其实还有很多其他映射，<span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;">DataBinding(Data-Widget)，XML-<wbr>Object-Swing，GWT(Java-JS)等等。</wbr></span></span>

</div>
<div><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;"><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;">很多东西抽象起来不过就是个Map，可以用循环遍历的东西，<wbr>为什么偏偏要用代码一个个机械的去列举，制造重复。<span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;">抽象力！！抽象力哪里去了？不要成了悲哀的码工。</span></span></wbr></span></span></span></span></div>
<div><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;"><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;"><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;"><strong>案例六</strong>：<a title="发现纯函数" href="http://yi-programmer.com/blog/2011-01-12_pure-code.html" target="_blank">发现纯函数</a>。<span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="text-align: left; line-height: 22px; font-family: TrebuchetMS, Arial, sans-serif; font-size: 15px;">函数式程序员可能清楚什么叫纯函数。<span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="text-align: left; line-height: 22px; font-family: TrebuchetMS, Arial, sans-serif; font-size: 15px;">发现纯函数，就是发现系统核心逻辑，提取（抽象）成不依赖IO，不依赖全局状态的代码，重新设计纯的输入和返回的数据结构，将他们置入独立的模块。其实除了文章中说的那些好处外，发现纯函数后，逻辑会被发现整理，而通常这些逻辑通常是独一无二的，但很可能散布在各个IO的地方，提取成纯函数并与IO分开后，更利于重用，消除重复。</span></span></span></span></span></span></span></span></span></span></div>
<div><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;"><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;"><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;">PS:另外推荐Martin Fowler一本重构的好书《<a href="http://book.douban.com/subject/1229923/">重构</a>》。</span></span></span></span></span></span></div>
<div><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;"><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-style-span" style="border-collapse: collapse; font-family: arial, sans-serif; font-size: 13px;"><span class="Apple-style-span" style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><img src="/uploads/2011/02/refactor_0001.jpg" alt="refactor.jpg" width="318" height="417" /></span></span></span></span></span></div>
</div>
</div>
</div>
</div>

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/blog/2011/01/dry-codepro-analitic" title="代码质量系列之五：利用CodePro Analytic工具检测和删除重复代码——Don't Repeat Yourself">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/blog/2011/02/cafe-bar-girls-qq" title="【趣味Hack】如何在咖啡厅，网吧等公共场所要到漂亮MM的QQ号">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'hackfisher'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>09 February 2011</span></div>

  
    <h4>Tags</h4>
    <ul class="tag_box">
    
    


  
     
    	<li><a href="/tags.html#代码质量 重复代码-ref">代码质量 重复代码 <span>1</span></a></li>
     
    	<li><a href="/tags.html#技术管理-ref">技术管理 <span>6</span></a></li>
    
  



    </ul>
    
  </div>
</div>


		  </div>
    </div> <!-- /container -->

    


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30459154-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



    <!-- JiaThis Button BEGIN -->
<script type="text/javascript">var jiathis_config = {data_track_clickback:true};</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?move=0&amp;uid=1344392196475354" charset="utf-8"></script>
<!-- JiaThis Button END -->
  </body>
</html>

